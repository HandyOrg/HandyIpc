<Project>
  <PropertyGroup Condition=" $(IsInDebugMode) != 'True' ">
    <HandyIpcTaskFolder Condition=" '$(MSBuildRuntimeType)' == 'Core' ">$(MSBuildThisFileDirectory)..\MSBuildCore20</HandyIpcTaskFolder>
    <HandyIpcTaskFolder Condition=" '$(MSBuildRuntimeType)' != 'Core' ">$(MSBuildThisFileDirectory)..\MSBuildFull46</HandyIpcTaskFolder>
  </PropertyGroup>

  <PropertyGroup Condition=" $(IsInDebugMode) == 'True' ">
    <HandyIpcTaskFolder Condition=" '$(MSBuildRuntimeType)' == 'Core' ">$(MSBuildProjectDirectory)\..\HandyIpc.BuildTasks\bin\$(Configuration)\netcoreapp2.1</HandyIpcTaskFolder>
    <HandyIpcTaskFolder Condition=" '$(MSBuildRuntimeType)' != 'Core' ">$(MSBuildProjectDirectory)\..\HandyIpc.BuildTasks\bin\$(Configuration)\net462</HandyIpcTaskFolder>
  </PropertyGroup>

  <UsingTask TaskName="HandyIpc.BuildTasks.GenerateCodeBuildTask"
             AssemblyFile="$(HandyIpcTaskFolder)\HandyIpc.BuildTasks.dll" />

  <Target Name="HandyIpcTask"
          BeforeTargets="CoreCompile">
    <Message Text="HandyIpcTaskFolder = $(HandyIpcTaskFolder) " />

    <GenerateCodeBuildTask IntermediateOutputPath="$(IntermediateOutputPath)"
                           SourceFiles="@(Compile)">
      <Output TaskParameter="ClientsCodePath"
              PropertyName="AutoGeneratedClientsFile" />
      <Output TaskParameter="ServersCodePath"
              PropertyName="AutoGeneratedServersFile"/>
    </GenerateCodeBuildTask>

    <Message Text="Auto generated clients file path = $(AutoGeneratedClientsFile) " />
    <Message Text="Auto generated servers file path = $(AutoGeneratedServersFile) " />

    <ItemGroup>
      <Compile Include="$(AutoGeneratedClientsFile)" />
      <Compile Include="$(AutoGeneratedServersFile)" />
    </ItemGroup>
  </Target>
</Project>
